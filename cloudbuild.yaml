steps:
  # 1. å‰å›ã®æœ€æ–°ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ã—ã¦ãƒ—ãƒ«ã™ã‚‹
  # åˆå›ã‚„ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒãªã„å ´åˆã¯å¤±æ•—ã™ã‚‹ã®ã§ã€|| true ã§ãƒ“ãƒ«ãƒ‰ã‚’ç¶šè¡Œã•ã›ã¾ã™
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker pull gcr.io/$PROJECT_ID/${_SERVICE_NAME}:latest || true

  # 2. ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’åˆ©ç”¨ï¼‰
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'build',
      '--cache-from', 'gcr.io/$PROJECT_ID/${_SERVICE_NAME}:latest', # å‰å›ã®çµæœã‚’å†åˆ©ç”¨
      '-t', 'gcr.io/$PROJECT_ID/${_SERVICE_NAME}:$COMMIT_SHA',
      '-t', 'gcr.io/$PROJECT_ID/${_SERVICE_NAME}:latest',           # æ¬¡å›ã®ãŸã‚ã«latestã‚¿ã‚°ã‚‚ä»˜ä¸
      '.'
    ]

  # 3. ãƒ“ãƒ«ãƒ‰ã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä¿å­˜ã™ã‚‹ï¼ˆå…¨ã¦ã®ã‚¿ã‚°ã‚’ãƒ—ãƒƒã‚·ãƒ¥ï¼‰
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/${_SERVICE_NAME}', '--all-tags']

  # 4. Cloud Run ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - '${_SERVICE_NAME}'
      - '--image'
      - 'gcr.io/$PROJECT_ID/${_SERVICE_NAME}:$COMMIT_SHA'
      - '--region'
      - 'asia-northeast1'
      - '--platform'
      - 'managed'
      - '--service-account'
      # ğŸ”§ã€ã“ã“ã‚’ç·¨é›†ã€‘ä½œæˆã—ãŸã€Œæ­£ã—ã„ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã€ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„
      - 'cloud-build-deployer-for-kinta@slack-kintai-bot-484306.iam.gserviceaccount.com'
      - '--memory'
      - '1Gi'
      - '--cpu'
      - '1'
      - '--timeout'
      - '300'
      - '--no-cpu-throttling'
      - '--project'
      - '$PROJECT_ID' # ğŸ”§ã€ã“ã“ã‚’ç·¨é›†ã€‘ä»¥å‰ ${PROJECT_ID} ã§ã—ãŸãŒã€$PROJECT_ID ãŒæ¨™æº–ã§ã™

options:
  logging: 'CLOUD_LOGGING_ONLY'