# v2.3 グループごと通知先管理 - 実装完了サマリー

## 概要

勤怠レポートの通知仕様を変更し、グループごとに通知先（admin_ids）を個別管理できるようにしました。

## 実装日時

2026-01-27

## 主な変更点

### 1. データ構造の変更

#### groupsコレクションにadmin_idsフィールドを追加

**Firestoreパス**: `groups/{workspace_id}/groups/{group_id}`

**変更後のドキュメント構造**:
```json
{
  "group_id": "group_a1b2c3d4",
  "name": "営業1課",
  "member_ids": ["U001", "U002", "U003"],
  "admin_ids": ["U100", "U101"],  // ← 新規追加
  "created_at": "2026-01-27T10:00:00",
  "updated_at": "2026-01-27T10:00:00",
  "created_by": "U000"
}
```

#### workspace_settingsのadmin_ids廃止

- `workspace_settings/{workspace_id}`の`admin_ids`フィールドは使用されなくなりました
- 各グループの`admin_ids`に移行
- 既存データは手動で削除する必要があります

### 2. サービス層の変更

#### GroupService (`resources/services/group_service.py`)

**追加されたメソッド**:

- `update_group_admins()`: グループの管理者（通知先）を更新
- `update_group()`: グループの名前、メンバー、管理者を一括更新

**変更されたメソッド**:

- `create_group()`: `admin_ids`パラメータを追加
- `create_group_with_name_as_id()`: `admin_ids`パラメータを追加
- `update_group_with_name_as_id()`: `admin_ids`パラメータを追加

#### NotificationService (`resources/services/notification_service.py`)

**完全書き換え: `send_daily_report()`**

v2.0版:
- 全グループの勤怠を1つのメッセージにまとめて送信
- workspace_settingsのadmin_idsにメンション

v2.3版:
- **グループごとに個別のメッセージを送信**
- 各メッセージの冒頭にそのグループのadmin_ids全員をメンション
- グループに所属するメンバーの勤怠のみを抽出
- ステータスごとにセクションを分けて表示（参考1の形式）

**メッセージ構造の変更**:

```
＠管理者1 ＠管理者2              ← グループのadmin_ids
*1/27(火)の勤怠*
━━━━━━━━━━━━━━━━
*全休：*
	山田太郎（腰痛）
	佐藤次郎（私用）

*AM休：*
	田中花子（有給消化）

（以下、各ステータスごとにセクション作成）
```

#### AttendanceService (`resources/services/attendance_service.py`)

**変更されたメソッド**:

- `get_daily_report_data()`: workspace_settingsのadmin_ids参照を削除
  - Note: v2.3以降、この関数は使用されていません

### 3. UI層の変更

#### モーダル定義 (`resources/templates/modals.py`)

##### レポート設定モーダル (v2.3)

**関数**: `build_admin_settings_modal()`

**変更内容**:
- `admin_ids`パラメータを削除（全社管理者の概念を廃止）
- グループ一覧表示に通知先を追加表示

**表示形式**:
```
*1課* (通知先:山田 花子)
清水 彩加, 山田 太郎
[編集/削除メニュー]
```

##### グループ編集モーダル (v2.3)

**関数**: `build_add_group_modal()`, `build_edit_group_modal()`

**変更内容**:
- 冒頭に「通知先」セクションを追加
- 順序: 通知先 → グループ名称 → 所属者

**モーダル構造**:
```
[通知先]
例：課長
ⓘここに登録されたユーザには9:00に勤怠情報が通知されます。
━━━━━━━━━━━━━━━━
[グループ名称]
例：4/5課
[所属者]
例：4/5課所属者
```

### 4. イベントリスナーの変更

#### AdminListener (`resources/listeners/admin_listener.py`)

**変更された処理**:

1. **グローバルショートカット「レポート設定」**
   - workspace_settingsのadmin_ids取得を削除
   - groupsのadmin_idsを表示名マップに含めるように変更

2. **レポート設定モーダル「保存」押下**
   - v2.3では何も保存しない（各グループで個別管理）

3. **グループ追加モーダル「保存」押下**
   - admin_idsの取得と保存を追加

4. **オーバーフローメニュー（編集）**
   - edit_group_modalにadmin_idsを渡すように変更

5. **グループ編集モーダル「保存」押下**
   - admin_idsの取得と更新を追加
   - `update_group()`メソッドを使用（名前、メンバー、管理者を一括更新）

6. **_update_parent_admin_modal()**
   - workspace_settingsのadmin_ids取得を削除
   - groupsのadmin_idsを表示名マップに含めるように変更

## 処理フローの変更

### 毎日9時のレポート送信

#### v2.0版（変更前）

```
1. workspaces/{workspace_id}から全グループを取得
2. workspace_settings/{workspace_id}からadmin_idsを取得
3. 全グループの勤怠を1つのメッセージにまとめる
4. admin_idsにメンションをつけて送信
```

#### v2.3版（変更後）

```
1. groups/{workspace_id}/groupsから全グループを取得
2. グループごとにループ:
   a. そのグループのadmin_idsを取得
   b. そのグループのmember_idsの勤怠のみを抽出
   c. ステータスごとにセクションを作成
   d. admin_idsにメンションをつけて個別に送信
3. グループの数だけメッセージが送信される
```

## ユーザー名表示の統一

システム全体で`user_id`から名前を引く際、以下の優先順位で取得:

1. `display_name` (最優先)
2. `real_name`
3. `user_id` (フォールバック)

**実装場所**:
- `SlackClientWrapper.fetch_user_display_name()`
- `SlackClientWrapper.fetch_user_name_map()`

## 環境対応

開発環境と本番環境でデータが混ざらないよう、Firestoreコレクション名に環境接尾辞を追加:

- 本番: `groups`, `attendance`, `workspace_settings`
- 開発: `groups_dev`, `attendance_dev`, `workspace_settings_dev`

**実装**: `resources/constants.py`の`get_collection_name()`関数

## 破壊的変更

### 削除された機能

1. **workspace_settingsのadmin_ids**
   - 全社管理者の概念を廃止
   - 既存データは手動で削除が必要

### マイグレーション手順

1. 既存のグループデータに`admin_ids`フィールドを追加:
   ```python
   from google.cloud import firestore
   from resources.constants import get_collection_name
   
   db = firestore.Client()
   workspace_id = "T01234567"
   
   # workspace_settingsからadmin_idsを取得
   ws_doc = db.collection(get_collection_name("workspace_settings")).document(workspace_id).get()
   old_admin_ids = ws_doc.to_dict().get("admin_ids", []) if ws_doc.exists else []
   
   # 各グループにadmin_idsを設定
   groups_ref = db.collection(get_collection_name("groups")).document(workspace_id).collection(get_collection_name("groups"))
   for doc in groups_ref.stream():
       doc.reference.update({"admin_ids": old_admin_ids})
   ```

2. workspace_settingsのadmin_idsを削除（任意）:
   ```python
   ws_ref = db.collection(get_collection_name("workspace_settings")).document(workspace_id)
   ws_ref.update({"admin_ids": firestore.DELETE_FIELD})
   ```

## テスト項目

1. グループ作成時にadmin_idsが保存されることを確認
2. グループ編集時にadmin_idsが更新されることを確認
3. レポート送信時、グループごとに個別メッセージが送信されることを確認
4. 各メッセージの冒頭にそのグループのadmin_idsがメンションされることを確認
5. グループに所属するメンバーの勤怠のみが表示されることを確認
6. ステータスごとにセクションが分かれて表示されることを確認
7. display_nameが優先的に表示されることを確認

## 関連ファイル

### 変更されたファイル

- `resources/services/group_service.py`
- `resources/services/notification_service.py`
- `resources/services/attendance_service.py`
- `resources/templates/modals.py`
- `resources/listeners/admin_listener.py`

### 新規作成ファイル

- `docs/v2.3_group_admin_implementation.md` (このファイル)

## 注意事項

1. **既存環境へのデプロイ時**
   - 既存のグループに`admin_ids`フィールドがない場合、レポートが送信されません
   - マイグレーション手順を実行してください

2. **データの削除**
   - workspace_settingsの`admin_ids`は手動で削除する必要があります
   - 削除しなくても動作に影響はありませんが、不要なデータが残ります

3. **レポート送信のパフォーマンス**
   - グループ数が多い場合、送信に時間がかかる可能性があります
   - 各グループで個別にメッセージを送信するため

## 今後の改善案

1. レポート送信の並列化（複数グループを同時送信）
2. admin_idsが空のグループへの警告表示
3. レポートプレビュー機能

---

実装完了日: 2026-01-27
バージョン: v2.3
