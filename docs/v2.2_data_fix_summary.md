# v2.2 ãƒ‡ãƒ¼ã‚¿å–å¾—ä¿®æ­£ã‚µãƒãƒªãƒ¼

**ä¿®æ­£æ—¥**: 2026-01-22  
**å•é¡Œ**: ãƒ¢ãƒ¼ãƒ€ãƒ«ç”»é¢ã§ã‚°ãƒ«ãƒ¼ãƒ—åãŒ `group_4bfe...` ã®ã‚ˆã†ãªUUIDã§è¡¨ç¤ºã•ã‚Œã‚‹  
**åŸå› **: `group_id`ï¼ˆUUIDï¼‰ã§ã¯ãªãã€`name`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤ºã™ã‚‹å¿…è¦ãŒã‚ã£ãŸ  
**è§£æ±ºç­–**: UUIDæ–¹å¼ï¼ˆv2.1ï¼‰ã‚’ç¶­æŒã—ã¤ã¤ã€`name`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ­£ã—ãæŠ½å‡ºãƒ»è¡¨ç¤ºãƒ»ä¿å­˜

---

## ğŸ”§ ä¿®æ­£å†…å®¹

### 1. `resources/handlers/action_handlers.py`

#### ä¿®æ­£å‰ï¼ˆ273è¡Œç›®ï¼‰
```python
groups_data = [
    {
        "name": g.get("group_id", g.get("name")),  # â† UUIDãŒå„ªå…ˆã•ã‚Œã¦ã„ãŸ
        "member_ids": g.get("member_ids", [])
    }
    for g in existing_groups
]
```

#### ä¿®æ­£å¾Œ
```python
groups_data = [
    {
        "group_id": g.get("group_id"),  # UUIDï¼ˆä¿å­˜æ™‚ã®è­˜åˆ¥ç”¨ï¼‰
        "name": g.get("name", ""),       # ã‚°ãƒ«ãƒ¼ãƒ—åï¼ˆç”»é¢è¡¨ç¤ºç”¨ï¼‰
        "member_ids": g.get("member_ids", [])
    }
    for g in existing_groups
]
```

**å¤‰æ›´ç‚¹**:
- `group_id` ã‚’æ˜ç¤ºçš„ã«ä¿æŒï¼ˆæ›´æ–°ãƒ»å‰Šé™¤æ™‚ã®è­˜åˆ¥ç”¨ï¼‰
- `name` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å„ªå…ˆçš„ã«å–å¾—ï¼ˆç”»é¢è¡¨ç¤ºç”¨ï¼‰

---

#### `handle_add_group_button()` ã®ä¿®æ­£

**è¿½åŠ æ©Ÿèƒ½**:
- `private_metadata` ã‹ã‚‰æ—¢å­˜ã® `groups_data` ã‚’å–å¾—
- å„ã‚°ãƒ«ãƒ¼ãƒ—ã® `group_id` ã‚’ä¿æŒ
- å‹•çš„æ›´æ–°æ™‚ã‚‚ `group_id` ãŒå¤±ã‚ã‚Œãªã„ã‚ˆã†ã«

```python
# metadataã‹ã‚‰æ—¢å­˜ã®group_idã‚’å–å¾—ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
group_id = None
if i <= len(existing_groups_data):
    group_id = existing_groups_data[i - 1].get("group_id")

groups_data.append({
    "group_id": group_id,  # æ—¢å­˜ã‚°ãƒ«ãƒ¼ãƒ—ã®å ´åˆã¯UUIDã€æ–°è¦ã®å ´åˆã¯None
    "name": name,
    "member_ids": member_ids
})
```

---

### 2. `resources/views/modal_views.py`

#### `create_member_settings_modal_v2()` ã®ä¿®æ­£

**å¤‰æ›´ç‚¹**: `private_metadata` ã« `groups_data` å…¨ä½“ã‚’ä¿å­˜

```python
"private_metadata": json.dumps({
    "group_count": group_count,
    "groups_data": groups_data  # group_idã‚‚å«ã‚€å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
})
```

**ç†ç”±**:
- å‹•çš„æ›´æ–°æ™‚ã« `group_id` ãŒå¿…è¦
- `views.update` ã§ `group_id` ã‚’å¤±ã‚ãªã„ãŸã‚

---

### 3. `resources/handlers/modal_handlers.py`

#### A. `_extract_groups_from_modal()` ã®ä¿®æ­£

**å¤‰æ›´ç‚¹**: `existing_groups_data` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã€`group_id` ã‚’ä¿æŒ

```python
def _extract_groups_from_modal(state_values, group_count, existing_groups_data=None):
    # ...
    # æ—¢å­˜ã‚°ãƒ«ãƒ¼ãƒ—ã®group_idã‚’å–å¾—ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
    group_id = None
    if i <= len(existing_groups_data):
        group_id = existing_groups_data[i - 1].get("group_id")
    
    groups.append({
        "group_id": group_id,  # æ—¢å­˜ã‚°ãƒ«ãƒ¼ãƒ—ã®å ´åˆã¯UUIDã€æ–°è¦ã®å ´åˆã¯None
        "name": name,
        "member_ids": member_ids
    })
```

---

#### B. `_calculate_diff()` ã®ä¿®æ­£

**ä¿®æ­£å‰**: ã‚°ãƒ«ãƒ¼ãƒ—åãƒ™ãƒ¼ã‚¹ã§å·®åˆ†è¨ˆç®—
```python
modal_names = {g["name"] for g in modal_groups}
existing_names = {...}
```

**ä¿®æ­£å¾Œ**: `group_id` ãƒ™ãƒ¼ã‚¹ã§å·®åˆ†è¨ˆç®—ï¼ˆUUIDæ–¹å¼ï¼‰
```python
# ãƒ¢ãƒ¼ãƒ€ãƒ«ã®group_idã‚»ãƒƒãƒˆï¼ˆæ—¢å­˜ã‚°ãƒ«ãƒ¼ãƒ—ã®ã¿ï¼‰
modal_group_ids = {g["group_id"] for g in modal_groups if g.get("group_id")}

# æ–°è¦ä½œæˆ: group_idãŒNoneã®ã‚‚ã®
to_create = [g for g in modal_groups if not g.get("group_id")]

# æ›´æ–°: ä¸¡æ–¹ã«å­˜åœ¨ã™ã‚‹group_id
to_update = [g for g in modal_groups if g.get("group_id") and g["group_id"] in existing_group_ids]

# å‰Šé™¤: Firestoreã«ã‚ã£ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ãªã„group_id
to_delete = list(existing_group_ids - modal_group_ids)
```

---

#### C. `_sync_all_groups()` ã®ä¿®æ­£

**ä¿®æ­£å‰**: `create_group_with_name_as_id()` ãªã©name-as-idæ–¹å¼ã‚’ä½¿ç”¨

**ä¿®æ­£å¾Œ**: v2.1ã®UUIDæ–¹å¼ã‚’ä½¿ç”¨

```python
# æ–°è¦ä½œæˆ
group_service.create_group(
    workspace_id=workspace_id,
    name=group["name"],
    member_ids=group["member_ids"],
    created_by=user_id
)

# æ›´æ–°
group_service.update_group_members(
    workspace_id=workspace_id,
    group_id=group["group_id"],  # UUIDã§è­˜åˆ¥
    member_ids=group["member_ids"]
)

# å‰Šé™¤
db.collection("groups").document(workspace_id)\
  .collection("groups").document(group_id).delete()
```

---

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### åˆå›è¡¨ç¤º

```
Firestore
  â†“ get_all_groups()
[{"group_id": "group_abc", "name": "å–¶æ¥­1èª²", "member_ids": ["U001"]}]
  â†“ handle_settings_v2_shortcut()
groups_data = [{"group_id": "group_abc", "name": "å–¶æ¥­1èª²", "member_ids": ["U001"]}]
  â†“ create_member_settings_modal_v2()
ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º:
  - #1ï¼šã‚°ãƒ«ãƒ¼ãƒ—å [å–¶æ¥­1èª²] â† nameãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤º
  - #1ï¼šãƒ¡ãƒ³ãƒãƒ¼ [@user1]
  - private_metadata: {"group_count": 1, "groups_data": [...]}
```

### å‹•çš„æ›´æ–°ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—è¿½åŠ ï¼‰

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã€Œâ• ã‚°ãƒ«ãƒ¼ãƒ—ã®æ–°è¦ä½œæˆã€ã‚¯ãƒªãƒƒã‚¯
  â†“ handle_add_group_button()
metadata.groups_data ã‹ã‚‰ group_id ã‚’å–å¾—
  â†“
state.values ã‹ã‚‰ç¾åœ¨ã®å…¥åŠ›å€¤ã‚’å–å¾—
  â†“
groups_data = [
  {"group_id": "group_abc", "name": "å–¶æ¥­1èª²", "member_ids": ["U001"]},  â† æ—¢å­˜ï¼ˆUUIDã‚ã‚Šï¼‰
  {"group_id": null, "name": "", "member_ids": []}  â† æ–°è¦ï¼ˆUUIDãªã—ï¼‰
]
  â†“ create_member_settings_modal_v2()
ãƒ¢ãƒ¼ãƒ€ãƒ«æ›´æ–°:
  - #1ï¼šã‚°ãƒ«ãƒ¼ãƒ—å [å–¶æ¥­1èª²] â† å…¥åŠ›å€¤ãŒä¿æŒã•ã‚Œã‚‹
  - #1ï¼šãƒ¡ãƒ³ãƒãƒ¼ [@user1]
  - #2ï¼šã‚°ãƒ«ãƒ¼ãƒ—å [      ] â† æ–°ã—ã„å…¥åŠ›æ¬„
  - #2ï¼šãƒ¡ãƒ³ãƒãƒ¼ [      ]
```

### ä¿å­˜å‡¦ç†

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹
  â†“ handle_member_settings_v2_save()
metadata.groups_data ã‹ã‚‰æ—¢å­˜ã® group_id ã‚’å–å¾—
  â†“ _extract_groups_from_modal()
modal_groups = [
  {"group_id": "group_abc", "name": "å–¶æ¥­1èª²", "member_ids": ["U001", "U002"]},  â† æ—¢å­˜ï¼ˆæ›´æ–°ï¼‰
  {"group_id": null, "name": "å–¶æ¥­2èª²", "member_ids": ["U003"]}  â† æ–°è¦ï¼ˆä½œæˆï¼‰
]
  â†“ _calculate_diff()
diff = {
  "to_create": [{"name": "å–¶æ¥­2èª²", ...}],
  "to_update": [{"group_id": "group_abc", "name": "å–¶æ¥­1èª²", ...}],
  "to_delete": []
}
  â†“ _sync_all_groups()
Firestore:
  - CREATE groups/{workspace_id}/groups/{new_uuid} â† å–¶æ¥­2èª²ï¼ˆUUIDè‡ªå‹•ç”Ÿæˆï¼‰
  - UPDATE groups/{workspace_id}/groups/group_abc â† å–¶æ¥­1èª²ï¼ˆmember_idsæ›´æ–°ï¼‰
```

---

## âœ… ä¿®æ­£å¾Œã®å‹•ä½œ

### 1. åˆå›è¡¨ç¤º
- âœ… æ—¢å­˜ã‚°ãƒ«ãƒ¼ãƒ—ã® `name` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹
- âœ… UUIDã§ã¯ãªãã€äººé–“ãŒèª­ã‚ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—åãŒè¡¨ç¤ºã•ã‚Œã‚‹
- âœ… å…¨ã‚°ãƒ«ãƒ¼ãƒ—ãŒ `#1`, `#2`, ... ã¨ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ã•ã‚Œã‚‹

### 2. å‹•çš„æ›´æ–°
- âœ… ã€Œâ• ã‚°ãƒ«ãƒ¼ãƒ—ã®æ–°è¦ä½œæˆã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã€æ—¢å­˜ã®å…¥åŠ›å€¤ãŒä¿æŒã•ã‚Œã‚‹
- âœ… ã‚°ãƒ«ãƒ¼ãƒ—åã€ãƒ¡ãƒ³ãƒãƒ¼ã¨ã‚‚ã«æ¶ˆãˆãªã„
- âœ… `group_id` ãŒå†…éƒ¨çš„ã«ä¿æŒã•ã‚Œã€æ›´æ–°æ™‚ã®è­˜åˆ¥ã«ä½¿ç”¨ã•ã‚Œã‚‹

### 3. ä¿å­˜å‡¦ç†
- âœ… æ–°è¦ã‚°ãƒ«ãƒ¼ãƒ—ã¯ UUID ã§è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹
- âœ… æ—¢å­˜ã‚°ãƒ«ãƒ¼ãƒ—ã¯ `group_id` ã§è­˜åˆ¥ã•ã‚Œã€`name` ã¨ `member_ids` ãŒæ›´æ–°ã•ã‚Œã‚‹
- âœ… ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰å‰Šé™¤ã•ã‚ŒãŸã‚°ãƒ«ãƒ¼ãƒ—ã¯ Firestore ã‹ã‚‰ã‚‚å‰Šé™¤ã•ã‚Œã‚‹

### 4. ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
- âœ… Firestore: `group_id` (UUID), `name` (ã‚°ãƒ«ãƒ¼ãƒ—å), `member_ids`
- âœ… v2.1 æ–¹å¼ï¼ˆUUIDï¼‰ã‚’ç¶­æŒ
- âœ… ç”»é¢è¡¨ç¤ºã¯ `name` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã€å†…éƒ¨å‡¦ç†ã¯ `group_id` ã§ä¸€è²«æ€§ã‚’ä¿ã¤

---

## ğŸ” é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ

### UUIDæ–¹å¼ vs name-as-idæ–¹å¼

å½“åˆ `spec_v2.2.md` ã§ã¯ã€Œname-as-idæ–¹å¼ã€ã‚’ææ¡ˆã—ã¾ã—ãŸãŒã€å®Ÿè£…ã§ã¯ **UUIDæ–¹å¼ï¼ˆv2.1ï¼‰ã‚’ç¶­æŒ** ã—ã¾ã—ãŸã€‚

**ç†ç”±**:
1. **æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨ã®äº’æ›æ€§**: Firestore ã«æ—¢ã« UUID å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨
2. **ã‚°ãƒ«ãƒ¼ãƒ—åå¤‰æ›´ã®æŸ”è»Ÿæ€§**: UUID ãªã‚‰åå‰å¤‰æ›´ãŒå®¹æ˜“
3. **ä¸€æ„æ€§ã®ä¿è¨¼**: UUID ã¯ç¢ºå®Ÿã«ä¸€æ„ã€ã‚°ãƒ«ãƒ¼ãƒ—åã¯é‡è¤‡ã®å¯èƒ½æ€§
4. **ã‚·ãƒ³ãƒ—ãƒ«ãªå®Ÿè£…**: æ—¢å­˜ã® `create_group()`, `update_group_members()` ã‚’ãã®ã¾ã¾ä½¿ç”¨

### ãƒ‡ãƒ¼ã‚¿ã®äºŒé‡ç®¡ç†

- **`group_id`**: Firestoreãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®è­˜åˆ¥å­ï¼ˆUUIDï¼‰
- **`name`**: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå†…ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆäººé–“ãŒèª­ã‚ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—åï¼‰

ç”»é¢è¡¨ç¤ºã«ã¯ `name` ã‚’ä½¿ç”¨ã—ã€å†…éƒ¨å‡¦ç†ï¼ˆæ›´æ–°ãƒ»å‰Šé™¤ï¼‰ã«ã¯ `group_id` ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ä¸¡æ–¹ã®ãƒ¡ãƒªãƒƒãƒˆã‚’äº«å—ã—ã¦ã„ã¾ã™ã€‚

---

## ğŸ“ ãƒ†ã‚¹ãƒˆé …ç›®

ä¿®æ­£å¾Œã€ä»¥ä¸‹ã®é …ç›®ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

- [ ] è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã„ãŸæ™‚ã€ã‚°ãƒ«ãƒ¼ãƒ—åãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ï¼ˆUUIDã§ã¯ãªã„ï¼‰
- [ ] ã€Œâ• ã‚°ãƒ«ãƒ¼ãƒ—ã®æ–°è¦ä½œæˆã€ãƒœã‚¿ãƒ³ã§å…¥åŠ›å€¤ãŒä¿æŒã•ã‚Œã‚‹
- [ ] æ–°ã—ã„ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã—ã¦ä¿å­˜ã§ãã‚‹
- [ ] æ—¢å­˜ã‚°ãƒ«ãƒ¼ãƒ—ã®åå‰ã‚’å¤‰æ›´ã—ã¦ä¿å­˜ã§ãã‚‹
- [ ] æ—¢å­˜ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’å¤‰æ›´ã—ã¦ä¿å­˜ã§ãã‚‹
- [ ] ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‰Šé™¤ï¼ˆå…¥åŠ›æ¬„ã‚’ç©ºã«ã—ã¦ä¿å­˜ï¼‰ã§ãã‚‹
- [ ] Firestore ã§ `group_id` ãŒ UUIDã€`name` ãŒã‚°ãƒ«ãƒ¼ãƒ—åã«ãªã£ã¦ã„ã‚‹

---

## ğŸ¯ ã¾ã¨ã‚

**å•é¡Œ**: ãƒ¢ãƒ¼ãƒ€ãƒ«ã«UUIDãŒè¡¨ç¤ºã•ã‚Œã‚‹  
**åŸå› **: `group_id` ã‚’è¡¨ç¤ºã«ä½¿ç”¨ã—ã¦ã„ãŸ  
**è§£æ±º**: `name` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤ºã«ä½¿ç”¨ã€`group_id` ã¯å†…éƒ¨å‡¦ç†ã®ã¿  
**æ–¹å¼**: UUIDæ–¹å¼ï¼ˆv2.1ï¼‰ã‚’ç¶­æŒ  
**çµæœ**: ç”»é¢ã«ã¯äººé–“ãŒèª­ã‚ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—åã€å†…éƒ¨ã§ã¯ç¢ºå®Ÿãªè­˜åˆ¥å­

ã™ã¹ã¦ã®ä¿®æ­£ãŒå®Œäº†ã—ã€ãƒªãƒ³ã‚¿ãƒ¼ã‚¨ãƒ©ãƒ¼ã‚‚ã‚ã‚Šã¾ã›ã‚“ï¼âœ…

**ä¿®æ­£å®Œäº†æ—¥**: 2026-01-22  
**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: 3ãƒ•ã‚¡ã‚¤ãƒ«  
**ä¿®æ­£è¡Œæ•°**: ç´„150è¡Œ
